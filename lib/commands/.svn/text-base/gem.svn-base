#!/usr/bin/env ruby

$LOAD_PATH.replace([])
APP_ROOT = File.join(File.dirname(__FILE__), '..')

$LOAD_PATH << File.join(APP_ROOT, 'ruby', 'lib')
$LOAD_PATH << File.join(APP_ROOT, 'ruby', 'lib', 'i686-darwin8.9.1')

GEM_DIR = File.join(APP_ROOT, 'ruby', 'gems')
$LOAD_PATH << GEM_DIR
ENV['GEM_HOME'] = GEM_DIR

# require File.join(File.dirname(__FILE__), *%w[.. config boot ])

# module Gem
#   @ruby = (File.join(Config::CONFIG['bindir'], 'shoes') + Config::CONFIG['EXEEXT']).
#           sub(/.*\s.*/m, '"\&"') + " --ruby"
# end
require 'rubygems'

Gem.use_paths(GEM_DIR, [GEM_DIR])
Gem.source_index.refresh!

# This file is only temporary.
# Usually, on deploy all the gems
# would be automatically vendorized

require 'rubygems/gem_runner'
require 'rubygems/exceptions'

# We need to preserve the original ARGV to use for passing gem options
# to source gems.  If there is a -- in the line, strip all options after
# it...its for the source building process.
args = !ARGV.include?("--") ? ARGV.clone : ARGV[0...ARGV.index("--")]

begin
  Gem::GemRunner.new.run args
rescue Gem::SystemExitException => e
  exit e.exit_code
end